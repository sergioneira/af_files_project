<!-- CSS only -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css" integrity="sha384-VCmXjywReHh4PwowAiWNagnWcLhlEJLA5buUprzK8rxFgeH0kww/aWY76TfkUoSX" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">
<link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />

<div class="container">
    <form>
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    <label for="client-full-info">Nombre completo del cliente:</label>
                    <select id="client-full-info" class="form-control">
                        {% for client in clients %}
                            <option value="Selection">Selección</option>
                            <option value="{{client.run}}">{{client.full_name}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group">
                    <label for="institution-info">Nombre instución:</label>
                    <select id="institution-info" class="form-control">
                        <option value="Selection">Selección</option>
                        {% for institution in institutions %}
                            <option value="{{institution.rut}}">
                                {{institution.business_name}}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-4">
                <div class="form-group">
                    <label for="registered-letter-number">
                        Número de la carta certificada
                    </label>
                    <input id="registered-letter-number" class="form-control" type="number" />
                </div>
            </div>
            <div class="col-4">
                <div class="form-group">
                    <label for="porcentaje-aumento-precio-base">
                        Porcentaje del aumento del precio base
                    </label>
                    <input id="porcentaje-aumento-precio-base" class="form-control" type="number" />
                </div>
            </div>
            <div class="col-4">
                <div class="form-group">
                    <label for="precio-base-original">
                        Precio base original
                    </label>
                    <input id="precio-base-original" class="form-control" type="number" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-4">
                <div class="form-group">
                    <label for="precio-base-reajustado">Precio base reajustado</label>
                    <input id="precio-base-reajustado" class="form-control" type="number">
                </div>
            </div>
            <div class="col-4">
                <div class="form-group">
                    <label for="precio-final-original">Precio final original</label>
                    <input id="precio-final-original" class="form-control" type="number">
                </div>
            </div>
            <div class="col-4">
                <div class="form-group">
                    <label for="precio-final-reajustado">Precio final reajustado</label>
                    <input id="precio-final-reajustado" class="form-control" type="number">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-4">
                <div class="form-group">
                    <label for="fecha-envio-carta">Fecha del envío de la carta:</label>
                    <input id="datepicker-first" width="276" />
                </div>
            </div>
            <div class="col-4">
                <div class="form-group">
                    <label for="fecha-recepcion-carta">Fecha de la recepción de la carta:</label>
                    <input id="datepicker-second" width="276" />
                </div>
            </div>
            <div class="col-4">
                <div class="form-group">
                    <label for="fecha-recepcion-carta">Mes comienza precio reajustado:</label>
                    <input id="datepicker-third" width="276" />
                </div>
            </div>
        </div>
    </form>

    <div class="container mt-5 mb-5">
        <textarea id="summernote">

        </textarea>
    </div>

    <button id="create-docx" class="btn btn-success">Crear documento</button>
</div>

{% block js %}
<!-- Libraries -->
<script src="https://unpkg.com/docx@5.0.2/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

<!-- JS, Popper.js, and jQuery -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/js/bootstrap.min.js" integrity="sha384-XEerZL0cuoUbHE4nZReLT7nx9gQrQreJekYhJD9WNWhH8nEW+0c5qq7aIo2Wl30J" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
<script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
<!-- Libraries -->

<!-- Datepickers -->
<script type="text/javascript">
    $('#datepicker-first').datepicker({
        uiLibrary: 'bootstrap4'
    });

    $('#datepicker-second').datepicker({
        uiLibrary: 'bootstrap4'
    });

    $('#datepicker-third').datepicker({
        uiLibrary: 'bootstrap4'
    });

    /*create_doc = document.getElementById('create_doc')
    create_doc.addEventListener('click', function(e) {
        let

        let health_plans = document.getElementById('health_plans')
        console.log(health_plans.options[health_plans.selectedIndex].value)
    })*/
</script>

<!-- Init summernote-->
<script>
    $(document).ready(function() {
        $('#summernote').summernote({
            height: 400,
        });
    });
</script>

<!-- Get protection appeal -->

<script>
    $.ajax(
        "/files/writing/"
    ).done(function(data) {
        $("#summernote").summernote("editor.pasteHTML", data)
    })
</script>

<!-- Download button -->
<script>
    create_doc = document.getElementById('create-docx')
    create_doc.addEventListener("click", () => {
        var a = $("#summernote").summernote('code')

        a = a.replace("NOMBRE_CLIENTE", "Sergio Neira")
        a = a.replace("RUT_CLIENTE", "17.756.179-7")

        let clients = document.getElementById('client-full-info')
        getClientInfo(clients.options[clients.selectedIndex].value)

        let institutions = document.getElementById('institution-info')
        getInstitutionInfo(institutions.options[institutions.selectedIndex].value)

        Export2Doc(a, clients.options[clients.selectedIndex].text)
    })
</script>

<!-- Download doc function -->

<script>
    function Export2Doc(content, filename = '') {
        var preHtml = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML To Doc</title></head><body>";
        var postHtml = "</body></html>";
        var html = preHtml + content + postHtml;

        var blob = new Blob(['\ufeff', html], {
            type: 'application/msword'
        });

        // Specify link url
        var url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);

        // Specify file name
        filename = filename ? filename + '.doc' : 'document.doc';

        // Create download link element
        var downloadLink = document.createElement("a");

        document.body.appendChild(downloadLink);

        if (navigator.msSaveOrOpenBlob) {
            navigator.msSaveOrOpenBlob(blob, filename);
        } else {
            // Create a link to the file
            downloadLink.href = url;

            // Setting the file name
            downloadLink.download = filename;

            //triggering the function
            downloadLink.click();
        }

        document.body.removeChild(downloadLink);
    }
</script>


<!-- Get client info based on run -->
<script>
    function getClientInfo(run) {
        url_client_info = `/files/client/${run}/`
        $.ajax(
            url_client_info
        ).done(function(data) {
            console.log(data)
        })
    }
</script>

<!-- Get institution info based on rut -->
<script>
    function getInstitutionInfo(rut) {
        url_institution_info = `/files/institution/${rut}/`
        $.ajax(
            url_institution_info
        ).done(function(data) {
            console.log(data)
        })
    }
</script>
{% endblock %}